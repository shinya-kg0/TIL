# EMRクラスターのステートレス化

EMRにおける**クラスターのステートレス化**とは、  
「クラスター（計算サーバー群）をいつでも使い捨て（削除・再作成）にできる状態にすること」を指します。

通常、サーバーの中にデータや設定（メタデータ）を持たせてしまうと、クラスターを消した瞬間にそれらも消えてしまいます。これを防ぐために、**「データ本体」と「データの定義情報（メタデータ）」をクラスターの外に切り出す**必要があります。

その核となる「EMRFS」と「外部メタストア」についてまとめます。

---

### 1. EMRFS (EMR File System) の活用

**～ データ本体の切り出し ～**

通常、Hadoopの世界ではHDFS（クラスター内のディスク）にデータを保存しますが、EMRFSを使うことで**Amazon S3をHadoopのファイルシステムとして直接扱う**ことができます。

* **役割**: クラスター内のローカルディスクではなく、耐久性の高い **S3** をストレージとして利用するためのインターフェースです。
* **ステートレス化への貢献**:
* **永続性**: クラスターをシャットダウンしても、データはS3に残ります。
* **スケーラビリティ**: ストレージ（S3）と計算リソース（EC2）を完全に分離できるため、データ量が増えても計算ノードを増やす必要がありません。
* **コスト削減**: 計算が終わったらクラスターを即座に削除できます。



---

### 2. 外部メタストアの活用

**～ データの定義情報の切り出し ～**

データがS3にあっても、「どのファイルがどのテーブルか」「列の名前や型は何か」という情報（メタデータ）がクラスター内のデータベースに保存されていると、クラスター消滅と共に「テーブル」としての認識ができなくなります。これを防ぐために外部のメタストアを使います。

#### 主な選択肢：AWS Glue データカタログ

現在、EMRで最も推奨される外部メタストアは **AWS Glue データカタログ** です。

* **役割**: Hive メタストアの代替として機能し、データベース名、テーブル名、列、パーティション情報などの情報を一元管理します。
* **ステートレス化への貢献**:
* **情報の共有**: 1つのカタログを複数のEMRクラスターで共有できます。例えば、「加工用のクラスターA」で作ったテーブルを、「分析用のクラスターB」や「Athena」から即座に参照できます。
* **カタログの永続化**: クラスターを削除してもテーブル定義が残るため、新しいクラスターを立て直すだけで以前の状態から作業を再開できます。



---

### 3. ステートレス化によるメリットのまとめ

| 項目 | ステートフル（従来） | ステートレス（EMR推奨） |
| --- | --- | --- |
| **データ保存先** | クラスター内のHDFS | **Amazon S3 (EMRFS)** |
| **メタデータ保存先** | クラスター内DB (MySQL等) | **AWS Glue データカタログ** |
| **クラスター運用** | 24時間365日動かし続ける | **必要な時だけ起動、終われば削除** |
| **コスト** | 高い（アイドル中も課金） | **低い（実行時間のみ課金）** |
| **スポット利用** | 困難（データ消失リスク） | **容易（スポットインスタンスに最適）** |

---

### ステートレス化の全体イメージ

1. **データ流入**: S3に生データが保存される。
2. **起動**: 処理が必要な時にEMRクラスターを起動。
3. **接続**: 起動時に「外部メタストア（Glue）」と「S3（EMRFS）」を繋ぎ込む設定を入れる。
4. **処理**: Sparkなどで計算。結果をS3に書き出し、Glueカタログを更新。
5. **削除**: 処理完了後、クラスターを破棄。
6. **後続処理**: AthenaやQuickSightがGlueカタログを介してS3のデータを直接分析。

### 深掘りポイント

もし運用をさらに最適化したい場合は、**「スポットインスタンス」**を組み合わせてみてください。ステートレス化されていれば、万が一スポットの回収でノードが消えても、データ本体や定義は外にあるため、被害を最小限に抑えつつコストを最大90%削減できます。


# Glue データカタログが選ばれる 4 つの理由

現在のAWS環境において、**外部メタストアは「AWS Glue データカタログ」を利用するのが圧倒的なデファクトスタンダード（事実上の標準）**です。

以前は自前で EC2 上に MySQL や PostgreSQL を立てて「Hive Metastore」を構築することもありましたが、現在は特別な理由がない限り Glue データカタログ一択と言っても過言ではありません。

その理由は、単に「EMR のメタデータ保存先」としてだけでなく、**データレイク全体の「共通インデックス（台帳）」**としての役割が非常に強力だからです。


## 1. サーバーレスで運用負荷がゼロ

自前で Hive Metastore（DB）を立てる場合、その DB のバックアップ、パッチ適用、スケーリング、可用性（マルチAZ化）を自分たちで管理しなければなりません。Glue カタログはフルマネージドサービスなので、これらの運用が一切不要です。

## 2. 強力なエコシステム連携（共通台帳）

これが最大の理由です。Glue カタログにテーブル情報を登録しておくだけで、以下の図のように AWS の様々な分析サービスが「同じテーブル」を同時に共有できます。

* **Athena**: EMR で作成したテーブルを即座に SQL でクエリできる。
* **Redshift Spectrum**: データウェアハウスから S3 上のテーブルを結合できる。
* **SageMaker**: 機械学習の学習データとしてカタログ経由でデータを読み込める。

## 3. クローラー（Crawler）による自動更新

S3 に新しいデータ（パーティション）が追加された際、クローラーを走らせるだけで、新しい列の追加や新しい日付フォルダの認識を自動で行い、カタログを更新してくれます。

## 4. Lake Formation による一元的な権限管理

**AWS Lake Formation** と組み合わせることで、「このユーザーは、このテーブルの『この列』だけ見せてよい」といった細かいセキュリティ制御を、カタログレベルで一括設定できます。

---

## 逆に Glue 以外の「外部メタストア」を使うのはどんな時？

デファクトスタンダードではありますが、あえて Glue 以外（自前の Hive Metastore など）を使うケースも稀にあります。

* **オンプレミスとのハイブリッド**: オンプレミスの Hadoop クラスターで使っている既存の Hive Metastore に、AWS 上の EMR からも接続したい場合。
* **極めて特殊な Hive のバージョン**: Glue カタログがまだ対応していない、最新すぎる、あるいは古すぎる Hive の特定の機能に依存している場合（現在ではほぼ解消されています）。


# デプロイパターン

Amazon EMRのデプロイパターンは、**「基盤の管理レベル（インフラ）」**と**「実行のライフサイクル（運用）」**の2つの軸で整理すると体系的に理解できます。

---

## 1. 基盤の管理レベルによる3つのデプロイタイプ

AWSが提供するEMRの形態は、現在大きく3種類あります。

| デプロイタイプ | 特徴 | 向いているケース |
| --- | --- | --- |
| **EMR on EC2** | インスタンスを直接管理。OSレベルのカスタマイズが可能。 | 長時間稼働、既存のHadoop資産の移行、細かいチューニングが必要な場合。 |
| **EMR on EKS** | Kubernetes上でコンテナとして実行。他のアプリとリソースを共有。 | 既にEKSを利用しており、分析基盤もコンテナで統一したい場合。 |
| **EMR Serverless** | サーバー管理不要。ジョブを投げるだけで自動スケーリング。 | インフラ管理を排除したい、断続的なジョブ実行、コスト最適化を優先したい場合。 |

---

## 2. 実行ライフサイクルによる2つのパターン

運用の観点では、クラスターを「ずっと立てておくか」「その都度立てるか」の2つのパターンがあります。

### ① 永続（永続的）クラスター (Persistent Cluster)

24時間365日、クラスターを起動し続けるパターンです。

* **メリット**: 起動待ち時間がなく、即座にクエリを実行できる。HBaseなどリアルタイム性が高いサービス向き。
* **デメリット**: 実行していない時間も課金されるため、コストが高くなりやすい。
* **活用例**: データの継続的なストリーム処理、BIツールからの頻繁なインタラクティブ・クエリ。

### ② 一時（トランジェント）クラスター (Transient Cluster)

ジョブ（Step）の実行時のみクラスターを作成し、完了後に自動で削除するパターンです。

* **メリット**: **コスト効率が最強。** 実行時間分しか課金されず、スポットインスタンスとの相性も抜群。
* **デメリット**: クラスターの起動に数分（2〜5分程度）のオーバーヘッドがかかる。
* **活用例**: 1日に数回のバッチETL処理、夜間の大規模な集計レポート。

---

## 3. ノード構成のパターン（EC2デプロイ時）

EMR on EC2を選択した場合、コストと安定性のバランスをとるためのノード構成パターンがあります。

* **パターンA：安定性重視**
* マスター：オンデマンド
* コア：オンデマンド または 予約済みインスタンス (RI)
* タスク：オンデマンド


* **パターンB：コスト最適化重視（推奨）**
* マスター：オンデマンド（司令塔なので落とさない）
* コア：オンデマンド（HDFSデータを保護するため）
* タスク：**スポットインスタンス**（計算専用なので、中断されても再試行すればOK）



---

## 4. データとメタデータの配置（ステートレス構成）

前述の通り、どのデプロイパターンを選んでも、以下の「ステートレス構成」をとることが大前提となります。

1. **ストレージ**: S3 (EMRFS) を使用し、クラスター内にデータを残さない。
2. **メタストア**: AWS Glue データカタログを使用し、テーブル定義を外出しする。

---

## まとめ：どのパターンを選ぶべきか？

* **「インフラ管理はしたくない、Spark/Hiveがメイン」**
👉 **EMR Serverless**
* **「とにかく安く、1日1回のバッチ処理を回したい」**
👉 **EMR on EC2 × 一時クラスター × スポットインスタンス**
* **「24時間、超高速でデータ検索に応答したい」**
👉 **EMR on EC2 × 永続クラスター × インスタンスフリート構成**

