# AWSネットワークの階層構造

AWSのインフラは、以下のような「マトリョーシカ」のような構造になっています。

## 1. リージョン (Region)

* **範囲：** 物理的な地理エリア（例：東京、オバマ、バージニア北部など）。
* **特徴：** **VPCはこの「リージョン」単位で作成します。** つまり、1つのVPCが東京とオバマをまたぐことはできません。

## 2. アベイラビリティゾーン (AZ)

* **範囲：** リージョン内にある、独立したデータセンター群。
* **特徴：** 1つのリージョンには、通常3つ以上のAZ（1a, 1c, 1dなど）があります。これらは物理的に離れているため、片方のAZが火災などでダウンしても、もう片方が生きていればサービスを継続できます（高可用性）。

## 3. サブネット (Subnet)

* **範囲：** VPCのIPアドレス範囲をさらに細かく分割した「区画」。
* **ここが重要！：** **サブネットは必ず「1つのAZ」に紐付けて作成します。**
* VPCはリージョン全体に広がっていますが、その中のサブネットは「AZ-1a用」「AZ-1c用」というように、特定のAZの中に作成します。
* 複数のAZをまたぐサブネットは作れません。


## パブリックサブネットとプライベートサブネットの違い

「パブリック」か「プライベート」かを決めるのは、実は設定（ルートテーブル）のわずかな違いだけです。

| 種類 | インターネット接続 | 主な用途 | 必須コンポーネント |
| --- | --- | --- | --- |
| **パブリック** | 直接できる（双方向） | Webサーバー、ALB（負荷分散装置） | インターネットゲートウェイ (IGW) |
| **プライベート** | 直接できない（内向き不可） | データベース、バックエンド処理 | NATゲートウェイ（外に出る場合のみ） |

### 仕組みの図解

1. **パブリックサブネット：**
* ルートテーブルに**「外の世界（0.0.0.0/0）に行くならインターネットゲートウェイ(IGW)を通ってね」**というルールが書かれているサブネットです。


2. **プライベートサブネット：**
* 上記のルールがありません。そのため、インターネットから直接アクセスされることがなく、セキュリティが高い区画になります。
* ※もしプライベートサブネットから「OSのアップデートだけしたい」という場合は、パブリック側にある**NATゲートウェイ**を経由して外に出ます。

## まとめ：関係性の整理

* **リージョン** の中に **VPC** を作る。
* **VPC** の中に **サブネット** を作る。
* **サブネット** を作る時は、どの **AZ** に置くか指定する。
* **サブネット** にインターネットへの道（IGW）を作れば **パブリック**、作らなければ **プライベート** になる。



# 1. AZとサブネットの関係（1：N）

「サブネットは1つのAZにしか所属できない」という制約はありますが、**「1つのAZには1つのサブネットしか置けない」という制約はありません。**

ひとつのデータセンター群（AZ）という物理的な場所に、論理的な仕切り（サブネット）を複数作るイメージです。

* **AZ-1aの中：**
* パブリックサブネット（Webサーバー用）
* プライベートサブネット（データベース用）


* **AZ-1cの中：**
* パブリックサブネット（予備）
* プライベートサブネット（予備）



このように、1つのAZの中で「表通り（パブリック）」と「裏庭（プライベート）」を分けることができます。

---

## 2. なぜ同じAZ内でサブネットを分けるのか？

「同じAZにあるなら、1つのサブネットにまとめてもいいのでは？」と思うかもしれません。しかし、分けるのには明確な理由があります。

### 理由①：セキュリティ（ルートテーブル）の管理

サブネットごとに**「ルートテーブル（通信の経路図）」**を紐付けます。

* パブリックサブネットには「インターネット出口」への道を教える。
* プライベートサブネットにはその道を教えない。
このように、通信制御のルールを「サブネット単位」で管理するため、役割ごとに分ける必要があります。

### 理由②：ネットワークACLによる制御

サブネット単位で通信のパケットフィルタリング（ネットワークACL）ができるため、より強固なセキュリティを構築できます。

---

## 3. 「マルチAZ」と「複数サブネット」の組み合わせ

実際の推奨構成は、以下のようになります。

| 階層 | AZ-1a (第1の拠点) | AZ-1c (第2の拠点) |
| --- | --- | --- |
| **パブリック層** | サブネットA | サブネットB |
| **プライベート層** | サブネットC | サブネットD |

このように配置することで：

1. **役割の分離：** サブネットを分けることで、DBをインターネットから隠す。
2. **物理的な冗長化：** AZを分けることで、1つのデータセンターがダウンしてもサービスを止めない。

この2つを同時に実現するのがAWSの標準的な設計です。


# VPCネットワーク

VPCネットワーク（プライベートサブネット）内から、インターネットを経由せずにアクセスするためにVPCエンドポイントが必要となる主要なAWSサービスは、大きく「ゲートウェイ型」と「インターフェース型」の2つのタイプに分けられます。

VPCエンドポイントを利用することで、インターネットゲートウェイやNATゲートウェイを設置していない閉域環境からでも、これらのサービスを安全に利用できるようになります。


## 1. ゲートウェイ型エンドポイント (Gateway Endpoints)

このタイプは**無料**で利用でき、ルートテーブルにターゲットを追加することで機能します。対応しているのは以下の2サービスのみですが、利用頻度は非常に高いです。

* **Amazon S3**: ファイルストレージ。ログの保存やバックアップに必須です。
* **Amazon DynamoDB**: NoSQLデータベース。

---

## 2. インターフェース型エンドポイント (Interface Endpoints)

**AWS PrivateLink**という仕組みを利用し、VPC内にプライベートIP（ENI）を作成して通信します。現在、多くの主要サービスが対応していますが、特によく使われるものは以下の通りです。

> ### AWS PrivateLink
> 
> インターネットを経由せずに、異なるVPCやAWSサービス、オンプレミス環境の間で、安全にプライベートな通信を可能にする技術
>
> #### PrivateLinkの主な仕組み  
> PrivateLinkは、サービスを提供する側（サービスプロバイダー）と、サービスを利用する側（サービスコンシューマー）を繋ぎます。
>
> - サービスプロバイダー側: 自身のサービスを「VPCエンドポイントサービス」として公開し、Network Load Balancer (NLB) に紐付けます。
>
> - サービスコンシューマー側: 自身のVPC内に「インターフェース型VPCエンドポイント（ENI）」を作成します。
>
> この2つがAWSの内部ネットワーク内で直接繋がるため、トラフィックは一度もパブリックなインターネットに出ることがありません。


### システム管理・セキュリティ

* **AWS Systems Manager (SSM)**: EC2にログインせず操作（Session Manager）したり、設定を管理したりする際に必須です。
* **AWS Key Management Service (KMS)**: データの暗号化・復号に使用します。
* **AWS Secrets Manager**: パスワードやAPIキーなどの機密情報を安全に取得するために使われます。

### ログ・監視

* **Amazon CloudWatch (Logs / Events / Metrics)**: アプリケーションのログ出力や監視に必要です。

### コンテナ・アプリケーション実行

* **Amazon ECR (api / dkr)**: ECSやEKSでコンテナイメージをプル（取得）する際に必要です。
* **AWS Lambda (API)**: VPC内からLambda関数を呼び出す際に使用します。
* **Amazon SNS / SQS**: メッセージングサービス。分散システムの連携によく使われます。

### インフラ操作

* **Amazon EC2 API**: VPC内から新しいインスタンスを起動したり、情報を取得したりする際に必要です。

---

## 構成のイメージ

通常、VPC外のサービス（Public Endpoint）へはインターネットを経由しますが、VPCエンドポイントを置くことでAWS内部のネットワークのみで完結します。

### どちらを優先すべき？

* **S3とDynamoDB**については、コストがかからない**ゲートウェイ型**をまず検討するのが一般的です。
* それ以外のサービスは**インターフェース型**を利用しますが、こちらは「エンドポイントの維持費」と「データ処理量」に応じて課金される点に注意が必要です。

