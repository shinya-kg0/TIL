# NAT

Network Adress Translation


- IPアドレスを変換する技術
  - プライベートIPをネットワークに繋ぎたい時にNATを使うことで通信可能になる
  - 入力方向、出力方向の2種類ある

# NAPT

NATを拡張した感じ、ポートまで変更することで複数のIPをまとめることができる。

- プライベート側に複数IPがあってもポートで振り分けできる

# NATゲートウェイ

VPCからインターネットに出ていく１方向のみ通信をしたい時に使うもの

- ユースケース
  - ミドルウェアのインストール（yum, apt-get）
  - Dockerイメージをプルしたい（ECR, DockerHub）
  - **VPCに属さないAWSマネージドサービスと通信したい（S3, SecretsManager, ECRなど）**

- **VPCエンドポイント**との比較
  - AWSマネージドサービス（S3など）のみ通信するならこっち
  - 他にインターネットに出ることがあるならNATゲートウェイ


# Amazon GuardDuty（探偵・監視カメラ）

AWS 環境全体の「ログ」をAIや機械学習で分析し、普段と違う動きや悪意のある操作を**見つけ出す**サービスです。

* **何を見張るか：** 不正なログイン試行、身に覚えのない場所からの操作、ウイルス感染したサーバーの挙動など。
* **具体例：** 「あなたの EC2 インフラが、勝手に暗号資産（仮想通貨）のマイニングに使われていますよ！」「盗まれたパスワードで誰かがログインしましたよ！」といった警告を出してくれます。
* **アクション：** 基本は「通知」です。通知を受けて、人間やプログラムが対処します。

# AWS Shield（防波堤・ボディーガード）

Web サイトやサーバーをダウンさせようとする **DDoS（ディードス）攻撃**から**インフラを保護する**サービスです。

* **何を防ぐか：** 大量の偽アクセスを送りつけてサイトをパンクさせる攻撃。
* **具体例：** 悪意のある大量のトラフィックが来ても、正規のユーザーがサイトを見続けられるように、攻撃データだけを自動でカットしてくれます。
* **プラン：** * **Standard（無料）：** 全ユーザーに自動適用されており、一般的なネットワーク攻撃を防ぎます。
* **Advanced（有料）：** より高度な攻撃への対応、専門チームによるサポート、攻撃によるコスト増の補填などがあります。


## 主な違いの比較表

| 特徴 | Amazon GuardDuty | AWS Shield |
| --- | --- | --- |
| **主な目的** | **脅威検知**（異常な動きを見つける） | **DDoS 保護**（大量アクセスから守る） |
| **防御対象** | AWS アカウント、IAM、EC2、S3 など | ネットワーク、Webアプリケーション |
| **得意なこと** | 乗っ取り、マイニング、内部不正の検知 | 大規模なサーバーダウン攻撃の阻止 |
| **動作イメージ** | ログを分析して「怪しい」と知らせる | 攻撃を自動的に「受け流す・遮断する」 |
| **料金** | 分析したログ量に応じた従量課金 | Standard は無料（Advanced は定額） |


# AWS Glue

- 「バラバラなデータを統合して、分析しやすい形に整える」ためのフルマネージド（サーバー管理不要）なサービスです。
- データ分析の現場では、データの準備（収集・洗浄・加工）に時間の 8 割が費やされると言われますが、AWS Glue はその作業（**ETL**）を自動化・効率化してくれます。

## 1. データカタログ（データの台帳）

- **役割:** どこに、どんなデータがあるかを管理する「辞書」のような存在です。
- **クローラ（Crawler）:** 自動で S3 などのストレージを見に行き、「このファイルは CSV 形式で、列名はこれですね」と判断してデータカタログに登録してくれます。

## 2. ETL ジョブ（加工の実行）

- **役割:** データの抽出 (Extract)、変換 (Transform)、ロード (Load) を行うプログラムです。
- **特徴:** Python や Scala で処理を書けますが、**AWS Glue Studio** という画面を使えば、コードを書かずにドラッグ＆ドロップで加工手順を作成することも可能です。

## 3. ジョブスケジューラ（実行の自動化）

- **役割:** 「毎日 2 時に実行する」とか「新しいファイルが届いたら実行する」といったトリガーを設定できます。

---

## 動作の全体イメージ

1. **クローラ**がデータをスキャンし、**データカタログ**に構造（スキーマ）を書き込む。
2. **ETL ジョブ**が、カタログ情報を元にデータを読み込み、不要な列を消したり形式を変換したりする。
3. 加工されたデータが、分析用の **Amazon Redshift** や **S3（データレイク）** へ保存される。
4. 保存されたデータは、**Amazon Athena** などからすぐにクエリして分析できる。

---

### Glue を使うメリット

- **サーバーレス:** サーバーを立てたり、容量を気にしたりする必要がありません。処理量に合わせて自動でスケールします。
- **コードの自動生成:** 複雑な変換コードを AWS がある程度自動で書いてくれます。
- **他サービスとの連携:** Athena、Redshift、EMR など、他の AWS 分析サービスと非常に相性が良いです。

---

### よくある疑問：Amazon EMR との違いは？

- **AWS Glue:** 「設定が楽」で「ETL（加工）」に特化。サーバー管理を一切したくない場合に最適。
- **Amazon EMR:** 「カスタマイズ性」が高い。ビッグデータ処理エンジン（Hadoop/Spark）を細かくチューニングしたい大規模な分析に最適。


# AWS EMR（Elastic MapReduce）

- 「膨大なデータを、大量のコンピューターで手分けして一気に処理する」ためのビッグデータプラットフォームです。
- 「1台の高性能なPCでも数日かかるような巨大な計算」を、**「100台のPCを並べて数時間で終わらせる」**といった、並列分散処理を得意としています。

---

## EMR の 3 つの特徴

## 1. 分散処理のフレームワークを簡単構築

通常、ビッグデータを扱うには「Apache Spark」や「Hadoop」といった専用のソフトウェアを自分でインストール・設定する必要がありますが、EMR なら数クリックでこれらがインストールされた環境が整います。

## 2. 柔軟なスケーリング（Elastic）

「処理を始める時だけ 100 台起動し、終わったら 0 台にする」といった使い方ができます。**必要な時だけリソースを確保できる**ため、コストを劇的に抑えられます。

## 3. S3 との強力な連携（EMRFS）

データそのものは安価な S3 に置いておき、計算する時だけ EMR を起動して S3 のデータを読みに行くという構成が一般的です。

---

## EMR の構成要素（クラスターとノード）

EMR は複数のサーバー（EC2インスタンス）がチーム（クラスター）を組んで動きます。役割は以下の3つに分かれます。

- **マスターノード:** チームのリーダー。全体の司令塔となり、どの作業をどのメンバーに振るかを決めます。
- **コアノード:** データの保存と計算の両方を行う主力メンバー。
- **タスクノード:** 計算だけを行う助っ人メンバー。忙しい時だけ追加して、終わったらすぐに解散させることができます。

---

## よくある比較：EMR vs Glue

どちらもデータ処理サービスですが、選び方の基準は明確です。

| **特徴** | **Amazon EMR** | **AWS Glue** |
| --- | --- | --- |
| **管理の自由度** | **高い**（OSやソフトをいじれる） | **低い**（設定のみのサーバーレス） |
| **コスト最適化** | スポットインスタンス等で**安くできる** | DPU（定額）による従量課金 |
| **得意なこと** | 自由度の高い分析、機械学習、大規模計算 | 定型的なデータの洗浄（ETL）、カタログ管理 |
| **使いやすさ** | インフラの知識が必要 | 専門知識が少なくても始めやすい |

---

## どんな時に使う？

- **大規模なログ分析:** 数テラバイト、数ペタバイトある過去数年分のログを、数時間で集計したい。
- **機械学習のモデル作成:** 膨大な学習データを使って、AIのモデルをトレーニングしたい。
- **ゲノム解析や科学計算:** 非常に複雑で大量の計算が必要な研究。

ユーザーがやることは主に **2 つだけ**です。

1. **「どんな計算をしたいか」というプログラム（Python や SQL など）を書く。**
2. **AWS の画面で「どのくらいのパワー（EC2 の種類や台数）で計算させるか」を決めて実行ボタンを押す。**

## 3. 利用のイメージ図

1. **データの置き場所 (S3):** まずは、分析したい巨大なファイル（ログなど）を S3 に置いておきます。
2. **EMR の起動:**
AWS コンソールから「EMR クラスターの作成」を選びます。「マスターノード 1 台、コアノード 4 台」のように構成を決めます。すると、**5 台の EC2 が自動で立ち上がります。**
3. **ジョブの送信:**
「この Python プログラムを実行して！」と EMR に命令を出します。
4. **並列処理:**
5 台の EC2 が手分けして計算を行います。
5. **結果の確認:**
終わったら S3 に保存された結果を確認します。


# ALB vs NLB

AWSのロードバランサー（ELB）における**ALB**（Application Load Balancer）と**NLB**（Network Load Balancer）の主な違いは、OSI参照モデルのどの階層（レイヤー）で動作し、「通信のどこを見て判断するか」にあります。

一言でいうと、**ALBは「中身を見て賢く振り分ける」**、**NLBは「とにかく高速に右から左へ受け流す」**という特性があります。

---

## 1. 比較まとめ表

| 項目 | ALB (L7) | NLB (L4) |
| --- | --- | --- |
| **正式名称** | Application Load Balancer | Network Load Balancer |
| **動作レイヤー** | レイヤー7（アプリケーション層） | レイヤー4（トランスポート層） |
| **主なプロトコル** | HTTP, HTTPS, gRPC | TCP, UDP, TLS |
| **振り分けの判断基準** | URLのパス、ホスト名、HTTPヘッダーなど | IPアドレス、ポート番号 |
| **静的IPの固定** | 不可（DNS名で運用） | **可能**（Elastic IPを割り当て可能） |
| **パフォーマンス** | 普通（秒間数百万リクエストも可だが、スケーリングに数分かかる） | **超高速・超低遅延**（突発的な負荷にも即座に対応） |
| **主な用途** | Webサイト、マイクロサービス、API | ゲーム、動画配信、固定IPが必要な通信 |

---

## 2. ALB（L7）の特徴：多機能でスマート

ALBは、通信の「中身（HTTPリクエスト）」を理解できます。

* **パスベースのルーティング：**
`example.com/images` へのアクセスは画像サーバへ、`example.com/api` はAPIサーバへ、といった細かい振り分けが可能です。
* **ホストベースのルーティング：**
`blog.example.com` と `shop.example.com` で振り分け先を変えられます。
* **WAFとの連携：**
AWS WAFと直接連携して、悪意のある攻撃（SQLインジェクションなど）をブロックしやすいのが特徴です。
* **Lambdaの呼び出し：**
ターゲットとしてEC2だけでなく、Lambda関数を指定することもできます。

---

## 3. NLB（L4）の特徴：高速・低遅延・固定IP

NLBは通信の中身（データの内容）は見ません。IPアドレスとポート番号だけを見て、高速に転送します。

* **静的IPアドレスの保持：**
NLBは各アベイラビリティゾーンごとに**固定のIPアドレス**を持つことができます。ファイアウォールで特定のIPのみ許可したいクライアントがある場合に必須です。
* **圧倒的なパフォーマンス：**
ALBよりもさらに低いレイテンシー（遅延）で動作し、秒間数百万件の突発的なリクエスト増にも「暖気運転」なしで対応できます。
* **ソースIPの保持：**
ターゲット（EC2など）側で、パケットの送信元IPアドレスをそのまま確認しやすい仕組みになっています。

---

## 4. どちらを選ぶべき？

* **「一般的なWebサイト・Webアプリ」なら ALB**
ほとんどのWebアプリケーション（HTTP/HTTPS）には、柔軟なルール設定ができるALBが最適です。
* **「ゲーム・IoT・動画配信・固定IP必須」なら NLB**
リアルタイム性が重視される通信や、HTTP以外のTCP/UDP通信、または接続元をIPで制限したい場合はNLBを選びます。

> [!TIP]
> 最近では、**「NLBの後ろにALBを置く」**という構成も可能です。これにより、NLBの「固定IP」というメリットと、ALBの「柔軟なパスルーティング」というメリットを両立させることができます。


結論から申し上げますと、2つを組み合わせる構成は「一般的」というよりは、**「特定の課題を解決するための高度なテクニック」**としてよく使われます。

通常のWebサイトであればALBだけで十分ですが、以下の**「ALBだけではできないこと」**を解決したい場合に、NLBの後ろにALBを置く構成（NLB → ALB → EC2など）が採用されます。

---

## なぜ組み合わせるのか？（主なメリット）

### 1. ロードバランサーの「IPアドレスを固定」したい

ALBのIPアドレスは変動するため、通常はDNS名（`xxx.ap-northeast-1.elb.amazonaws.com`）で運用します。しかし、クライアント側のファイアウォール設定などで「接続先IPを1つに絞って許可してほしい」と言われるケースがあります。

* **解決策：** 固定IP（Elastic IP）を持てる**NLB**を窓口にし、リクエストを**ALB**に流すことで、固定IPを維持しつつALBの便利な機能（URLパス振り分けなど）を使えます。

### 2. AWS PrivateLink でサービスを提供したい

自社のVPC内にあるサービスを、他のAWSアカウントやVPCからセキュアに呼び出してもらいたい場合（PrivateLink）、窓口には必ず**NLB**が必要になります。

* **解決策：** NLBをエンドポイントとして公開し、内部のルーティングはALBに任せるという構成をとります。

---

## デメリットも考慮が必要

この構成は非常に強力ですが、以下の点には注意が必要です。

* **コストの二重課金：** NLBとALBの両方の稼働料金がかかります。
* **運用の複雑化：** 管理対象のロードバランサーが2つになるため、トラブルシューティング時の調査ポイントが増えます。
* **ヘルスチェック：** NLBがALBの状態を正しく検知できるよう設定に気を配る必要があります。

---

## 結論：いつ使うべき？

* **基本的には：** **ALB単体**でOKです。最近のWeb運用ではIP固定を求められないことも増えています。
* **必要になったら：** 「どうしても固定IPが必要になった」「PrivateLinkを使いたい」という要件が出てきた時に、この**組み合わせ構成**を検討するのがスムーズです。

ちなみに、最近では**AWS Global Accelerator**を使ってALBのIPを固定する方法もあり、構成の選択肢は広がっています。

もし、いま構築しようとしているシステムで「固定IPが必要」などの制約はありますか？それによって最適な構成が変わってきます。


# EFSとEBSの違い


EBSとEFSの最大の違いの一つは、仰る通り「**複数のインスタンスで同時に共有できるかどうか**」という点にあります。

結論から言うと、**「標準で共有を前提としているのがEFS」**であり、**「特殊な条件下でのみ共有できるのがEBS」**です。

---

### 1. Amazon EFS (Elastic File System)

EFSは、最初から**複数のインスタンスで共有することを目的**とした「ネットワークファイルシステム（NFS）」です。

* **共有の可否**: 容易に可能。**数千台**のEC2インスタンスから同時に読み書きができます。
* **範囲**: **複数のアベイラビリティゾーン (AZ)** をまたいで共有可能です。
* **特徴**: マネージドサービスなので、容量は自動で伸縮します。Linuxインスタンスでマウントして、「共有フォルダ」のように使います。

### 2. Amazon EBS (Elastic Block Store)

EBSは、本来**1台のEC2につき1つのボリューム**を直接つなぐ「外付けハードディスク」のようなブロックストレージです。

* **共有の可否**: 原則不可ですが、**「EBS Multi-Attach」**という機能を使うことで、一部のボリュームタイプに限り共有が可能です。
* **Multi-Attachの厳しい条件**:
* **ボリュームタイプ**: `io1` または `io2` (高性能なProvisioned IOPS SSD) のみ。
* **範囲**: **同一のAZ内**にあるインスタンス間のみ（AZをまたげません）。
* **台数**: 最大 **16台** まで。
* **データ整合性**: EFSと違い、ファイルシステムレベルでの書き込み制御がないため、アプリケーション側で「誰がいつ書き込むか」を制御する仕組み（クラスタソフトウェア等）が必要です。



---

### 比較まとめ表

| 機能 | Amazon EFS | Amazon EBS (Multi-Attach) |
| --- | --- | --- |
| **ストレージ種別** | ファイルストレージ (NFS) | ブロックストレージ (NVMe) |
| **共有台数** | 数千台 | 最大16台 |
| **AZまたぎ** | **可能** | **不可** (同一AZのみ) |
| **主な用途** | Webサーバのコンテンツ共有、ログ集約 | データベースのクラスタ構成 (RAC等) |
| **難易度** | 低い（OSでマウントするだけ） | 高い（書き込み制御の設計が必要） |

### どちらを選ぶべき？

* **一般的なファイル共有**（「みんなで同じ画像フォルダを見たい」「ログを1箇所にまとめたい」など）であれば、迷わず **EFS** を選んでください。
* **特定のクラスタ用データベース**など、極めて高いI/O性能とミリ秒未満のレイテンシが求められ、かつ自分で書き込み制御ができる高度な構成の場合にのみ、**EBS Multi-Attach** を検討します。


# S3 vs DynamoDB

はい、DynamoDBに**非構造化データを保存することは可能**です。

DynamoDBは「スキーマレス」なNoSQLデータベースであるため、あらかじめテーブルの列（カラム）を固定する必要がなく、項目（レコード）ごとに異なる属性を持たせることができます。

ただし、データの「形式」や「サイズ」によって、DynamoDBが向いているケースと、別のサービス（S3など）を組み合わせるべきケースがあります。

---

### 1. 保存できるデータ形式

DynamoDBは、主に**JSONのような階層構造を持つデータ（半構造化データ）**の扱いに長けています。

* **ドキュメント型データのサポート**: `Map`（ネストされたオブジェクト）や `List`（配列）というデータ型をサポートしており、複雑なJSON構造をそのまま保存できます。
* **属性の柔軟性**: 全ての項目に共通の項目（プライマリキー）さえあれば、それ以外の項目はバラバラで問題ありません。

### 2. 注意が必要な「400KB」の壁

非構造化データといっても、画像、音声、動画、巨大なログファイルなどはDynamoDBへの直接保存には向きません。

* **サイズ制限**: 1つの項目（レコード）の最大サイズは **400KB** です。これを超えるデータは保存できません。
* **コスト**: 大きなデータを頻繁に読み書きすると、書き込み/読み込みキャパシティ（WCU/RCU）を大量に消費し、コストが跳ね上がります。

### 3. AWSでの推奨構成（S3との組み合わせ）

「画像ファイル」や「数MBを超えるPDF」などの完全な非構造化データを扱う場合、以下の**デザインパターン**が一般的です。

* **実データ**: **Amazon S3** に保存する。
* **メタデータ（管理情報）**: **DynamoDB** に保存する（S3上のファイルのパスや、ファイル名、作成日、ユーザーIDなど）。

| データの種類 | 保存先 | 理由 |
| --- | --- | --- |
| **JSON、メタデータ、設定値** | **DynamoDB** | 高速な検索、柔軟なスキーマ、400KB以下 |
| **画像、動画、PDF、大容量ログ** | **S3** | 容量無制限、低コスト、ファイル単位の管理 |

---

### まとめ

DynamoDBは「柔軟な構造のデータ（JSONなど）」を保存するのには非常に適していますが、物理的な「ファイル」そのものを大量に溜め込むための場所ではありません。


# Kinesis Data Streamsのシャード

→ 高速道路の車線のようなもの

- データ: 道路を走る「車」
- ストリーム（全体）: 「高速道路」そのもの
- シャード: 高速道路にある 「車線（レーン）」



- シャードを増やす = 「車線を増やして」大量のデータを捌けるようにすること。
- 1シャードの限界 = 秒間1MB / 1,000件。
- パーティションキー = どの車線を走るかを決めるためのチケット。

「大量のデータが来るから、とりあえず10シャード用意しておこう」といった具合に、処理能力の蛇口を調整するつまみのようなものだと考えると分かりやすいです。


シャードの分割、統合とは、  
全体とデータの流れをシャードでどれぐらい分割するかというイメージのほうが近い

→ データ量が多いとシャードを増やして対応（全体のデータをより多くのシャードで分割している）  
→ データ量が少ないとシャードを減らして対応（全体のデータを分けるシェードを減らす（統合している））


