# abstract

## SparseDrive：スパース表現を用いた効率的かつ安全なエンドツーエンド自動運転

### 1. 従来の課題

従来の自動運転システムには、主に2つのアプローチがありますが、それぞれに課題がありました。

* **モジュール型:** 認知・予測・計画を個別のタスクに分離。モジュール間での**情報損失**や**エラーの蓄積**が問題となる。
* **エンドツーエンド型:** 全体を一つの枠組みで最適化できるが、**計算コストが高い（BEV画像生成など）**、**計画の安全性が不十分**といった欠点がある。

### 2. 提案手法：SparseDrive の特徴

SparseDriveは、**「スパース表現（疎な表現）」**を活用することで、効率と精度の両立を目指しています。

* **対称型スパース認識モジュール:**
検知・追跡・オンラインマッピングを、統一された対称的なアーキテクチャで処理します。シーン全体を密なデータ（BEVなど）ではなく、必要な要素のみを抽出した「疎なデータ」として学習します。
* **並列モーションプランナー:**
「他者の動きの予測」と「自車の走行計画」の類似性に着目し、これらを並列で実行する設計を採用しました。
* **階層的な計画選択戦略:**
走行計画を「マルチモーダル（複数の候補）」として捉え、衝突リスクを考慮したスコアリングを行うことで、最も合理的で安全な経路を選択します。

### 3. 本研究の成果

* **高性能・高効率:** 従来のSOTA（最先端手法）を大幅に上回る精度を全タスクで記録しました。
* **計算の高速化:** スパース表現の採用により、学習および推論の効率が劇的に向上しています。
* **安全性の向上:** 新しい選択戦略により、エンドツーエンド手法の弱点であった「計画の安全性」が強化されました。



# Introduction


## 1. 従来の「BEV中心」モデルの限界

先行研究（UniADなど）では、計算負荷の高いBEV特徴量を生成していましたが、以下の3つの共通点が無視されていました。

* **相互作用の欠如:** 他車の予測と自車の計画を順次行うため、自車が周囲に与える影響が考慮されない。
* **情報の不均衡:** 他車には認知タスクからの意味・幾何情報が活用されるが、自車（Ego）にはそれらが反映されにくい。
* **不確実性の無視:** 本来マルチモーダル（複数の可能性がある）な計画タスクを、決定論的な1つの軌道として扱っている。

## 2. SparseDrive の革新的なアプローチ

SparseDriveは、疎なインスタンス表現を用いることで、これらの課題を解決しています。

### **対称型スパース認識 (Symmetric Sparse Perception)**

* 検出、追跡、オンラインマッピングを、**対称的なモデルアーキテクチャ**で統合。
* インスタンスの特徴量と幾何学的アンカーを分離して保持し、シーン全体を「疎なデータ」として効率的に表現します。

### **並列モーションプランナー (Parallel Motion Planner)**

* **並列設計:** モーション予測（他車）とプランニング（自車）を同時に実行。これにより、エージェント間の高次かつ双方向の相互作用を捉えます。
* **マルチモーダルな計画:** 自車の計画においても複数の軌道候補を生成。
* **階層的選択戦略:** 生成された候補から、衝突検知を考慮した再スコアリング（Collision-aware rescore）を行い、最も安全な軌道を選択します。

## 3. 圧倒的なパフォーマンスと効率

既存の最高水準モデル（UniAD）と比較して、以下の数値を達成しています。

| 項目 | 改善・比較結果 |
| --- | --- |
| **計画エラー (L2)** | **19.4% 削減** (0.72m → 0.58m) |
| **衝突率** | **71.4% 削減** (0.21% → 0.06%) |
| **学習速度** | **7.2倍 高速** (144時間 → 20時間) |
| **推論速度 (FPS)** | **5.0倍 高速** (1.8 FPS → 9.0 FPS) |



# Related Work

SparseDriveの背景には、3D検知、トラッキング、マッピング、予測、計画という5つの分野の進歩があります。

## 2.1 多視点3D検知 (Multi-view 3D Detection)

画像から3D空間を認識する手法は、大きく3つの流れに分かれます。

* **LSS系:** 画像特徴量を深度推定によって3D空間へ引き上げ、BEV（俯瞰図）平面に投影する手法。
* **BEV Query系:** BEV上のクエリを定義し、画像から特徴をサンプリングする手法。
* **スパース（疎）系 (Sparse4D等):** 密なBEV特徴量を使わず、3D空間上の特定の点（アンカー）を画像に投影して特徴を集約する手法。**SparseDriveはこの流れを汲んでいます。**

## 2.2 エンドツーエンド・トラッキング (End-to-End Tracking)

従来の「検知した後に紐付け（データ照合）を行う」手法から、ニューラルネットワーク内で完結する手法への移行が進んでいます。

* **Track Query:** インスタンスをクエリとして保持し、時系列で追跡。
* **Sparse4Dv3:** 時間的に伝播されたインスタンスが既に同一性を保持していることを示し、シンプルなID割り当てで最高性能（SOTA）を達成。

## 2.3 オンライン・マッピング (Online Mapping)

高コストな高精度（HD）マップの代わりに、走行中にリアルタイムで地図要素をベクトル化する技術です。

* **VectorMapNet / MapTR:** 地図要素を点の集合やベジエ曲線としてモデル化し、ベクトル形式で出力。
* **StreamMapNet:** 時系列情報を活用して安定した地図生成を実現。

## 2.4 エンドツーエンド・モーション予測 (End-to-End Motion Prediction)

前段のモジュールからのエラー累積を防ぐため、検知・追跡と予測を統合する試みです。

* **ViP3D / PIP:** エージェント（他車など）クエリやベクトル化されたローカルマップを用いて、将来の軌道を予測します。

## 2.5 エンドツーエンド・プランニング (End-to-End Planning)

最終的な「走行計画」を直接出力する手法です。

* **初期の手法:** 認識タスクを飛ばして直接計画を出力していたが、解釈性に欠け、最適化が困難だった。
* **コストマップ型:** 手法認識結果からコストマップを作成し、最小コストの軌道を選択。
* **最新の統合型 (UniAD / VAD):** 全タスクを統一されたクエリで統合。しかし、これらは**「予測」と「計画」の類似性**を十分に活用できておらず、パフォーマンスに限界がありました。


# Method


## 3.1 概要 (Overview)

SparseDriveは大きく分けて3つのコンポーネントで構成されています（図2参照）。

1. **画像エンコーダ:** 多視点カメラからの画像入力を、マルチスケールの特徴マップへと変換します。
2. **対称型スパース認識:** 前述の特徴マップから、「周囲のエージェント（他車など）」と「地図要素」の2つのグループを抽出し、シーンの疎な表現を学習します。
3. **並列モーションプランナー:** 認識された他車・地図情報と、初期化された自車（Ego）情報を統合。他車の予測と自車の計画を同時に行い、最終的に安全な軌道を選択します。

## 3.2 対称型スパース認識 (Symmetric Sparse Perception)

図3に示されるように、このモジュールは**検出・追跡・オンラインマッピングを統合した、構造的な対称性**を持っています。

### **スパース検出 (Sparse Detection)**

* **表現:** 各エージェントは「インスタンス特徴量」と「アンカーボックス（位置、サイズ、角度、速度の11パラメータ）」で表現されます。
* **構造:** デコーダ群（非時系列1つ ＋ 時系列個）で構成されます。
* **プロセス:** アンカー周辺にキーポイントを生成して特徴マップからサンプリングし、インスタンス特徴量を更新。これを繰り返して、分類精度とボックスの精度を高めます。時系列デコーダでは、過去のフレームからの情報もアテンション機構（Self/Cross-Attention）を通じて統合します。

### **スパース・オンラインマッピング (Sparse Online Mapping)**

* 検出ブランチと全く同じモデル構造を共有していますが、扱う対象が異なります。
* **表現:** 静的な地図要素は、複数の点で構成される「アンカーポリライン」として定義されます。これにより、道路の境界や車線などをベクトル形式で認識します。

### **スパース・トラッキング (Sparse Tracking)**

* **ID割り当て:** 特定の信頼度しきい値を超えたインスタンスにIDを付与します。
* **特徴:** 複雑なデータ照合アルゴリズムを必要とせず、時系列的な伝播によってIDを維持する非常にシンプルでエレガントな設計です。


このセクションの肝は、**「動く他車の検出」と「動かない地図の認識」を、全く同じネットワーク構造（デコーダ）で処理している**点にあります。これにより、モデルがシンプルになり、計算効率が飛躍的に向上しています。



## 3.3 並列モーションプランナー (Parallel Motion Planner)

このモジュールは、自車（Ego）と周囲のエージェントを「同等の存在」として扱い、相互作用を考慮しながら安全な走行ルートを決定します。

### 1. 自車インスタンスの初期化 (Ego Instance Initialization)

自車も他車と同様に、特徴量 () とアンカーボックス () で表現されます。

* **セマンティック情報の注入:** 自車はカメラの死角になるため、通常の方法では特徴抽出ができません。そこで、フロントカメラの最小スケールの特徴マップからプーリングによって特徴を抽出します。これにより、シーン全体の文脈（道路状況など）を自車情報に取り込み、スパース認識で漏れた障害物への補完機能も持たせています。
* **速度の初期化:** 正解データ（Ground Truth）の速度をそのまま使うと、モデルが未来の情報を知ってしまう「リーク」が発生するため、前フレームの予測速度を使用します。

### 2. 時空間的な相互作用 (Spatial-Temporal Interactions)

自車と他車を一つのグループ（Agent-level instances）として結合し、以下の3つのアテンション機構で複雑な関係性を学習します。

* **エージェント・時間クロスアテンション:** 各インスタンスが自分自身の過去の履歴に注目します。
* **エージェント・エージェント セルフアテンション:** 自車と他車、あるいは他車同士の「譲り合い」や「追従」などの高次な相互作用を考慮します。
* **エージェント・マップ クロスアテンション:** 走行車線や交差点などの地図情報に基づいた動きを学習します。

このプロセスの後、他車の将来予測（Motion Prediction）と、自車の複数の走行候補（Planning Proposals）を**同時に**出力します。

### 3. 階層的な計画選択戦略 (Hierarchical Planning Selection)

複数の走行候補から、最終的な1つの軌道を選択するプロセスです。

1. **コマンド選択:** 与えられた指示（右折、左折、直進）に合致する候補を絞り込みます。
2. **衝突検知による再スコアリング (Collision-aware rescore):** 同時に予測した「他車の将来軌道」と、自車の候補を照らし合わせます。衝突のリスクがある候補のスコアを大幅に下げ（実際には0に設定）、安全性を担保します。
3. **最終決定:** 最もスコアの高い、合理的かつ安全な軌道を選択します。

---

### 要点：なぜ「並列」が良いのか？

従来の「他車の動きを予測してから自車の動きを決める」という順次的な設計では、**「自車が動くことで他車がどう反応するか」**という双方向のインタラクションが抜け落ちていました。SparseDriveはこれらを並列に、かつマルチモーダル（複数の可能性）に処理することで、より人間に近い柔軟で安全な判断を可能にしています。



## 3.4 エンドツーエンド学習 (End-to-End Learning)

SparseDriveの学習プロセスは、効率性と安定性を高めるために2段階の構成となっています。

### 1. 2段階のトレーニング (Multi-stage Training)

* **ステージ1 (認識学習):**
まず、対称型スパース認識モジュールをゼロから学習させます。ここでは、周囲のエージェント（他車など）や地図要素を正確に「スパース表現」として抽出する能力を養います。
* **ステージ2 (統合学習):**
認識モジュールとモーションプランナーを統合して学習します。この際、**重みの固定（フリーズ）は行わず**、モデル全体をエンドツーエンドで最適化します。これにより、最終的な目的である「走行計画」に最適化された認識能力を獲得できます。

### 2. 損失関数 (Loss Functions)

学習をガイドする損失関数（Loss）は、主に以下の5つの要素の合計  で構成されます。

* **各タスクの構成:** 検出 ()、マッピング ()、予測 ()、計画 () のそれぞれにおいて、**「分類（正解か）」**と**「回帰（位置や角度のズレ）」**の両方の損失を計算します。
* **Winner-takes-all 戦略:** マルチモーダルな予測と計画において、最も正解に近い候補（Winner）のみを最適化の対象とする手法を採用し、学習の効率を高めています。
* **補助タスク ():** 奥行き推定（深度推定）を補助タスクとして加えることで、認識モジュールの学習をより安定させています。

---

### 要点：なぜ2段階に分けるのか

最初からすべてを学習させようとすると、複雑すぎて収束が難しくなります。まず「周りを見る力（認識）」を育ててから、それを「運転の判断（計画）」に繋げることで、高精度なエンドツーエンドモデルを実現しています。




# Experiments

実験は、1,000の複雑な走行シーンを含む難易度の高いデータセット **nuScenes** で実施されました。

## 4.1 主要な成果

SparseDriveには2つのモデル（軽量版のSとベース版のB）がありますが、軽量版のSであっても、従来の主要なエンドツーエンドモデル（UniADなど）をすべてのタスクで上回る結果を出しています。

### **1. 認識性能 (Perception)**

* **3D検知:** UniADに対し、精度指標であるmAPで**+11.6%**、NDSで**+9.0%**という大幅な改善を達成。
* **トラッキング:** AMOTA（追跡精度）が+14.2%向上し、IDスイッチ（追跡対象の取り違え）は**30.2%減少**。一貫した追跡能力が証明されました。
* **マッピング:** オンライン地図作成のmAPも56.2%に達し、VAD[20]を+8.6%上回りました。

### **2. 予測性能 (Prediction)**

他車の将来軌道予測において、平均誤差（minADE）が**15.5%削減**され、極めて高い予測精度を実現しました。

### **3. 走行計画性能 (Planning) ★最重要ポイント**

自動運転の最終目的であるプランニングにおいて、驚異的な数値を記録しています。

* **L2誤差（経路のズレ）:** 0.58m（VAD比 **19.4%削減**）
* **衝突率:** **0.06%**（VAD比 **71.4%削減**）

> この結果は、提案された「衝突を考慮した再スコアリング（Collision-aware rescore）」が、安全性の向上に極めて有効であることを示しています。

### **4. 効率性 (Efficiency)**

性能だけでなく、計算コストの低さも際立っています。

| 比較対象 (vs UniAD) | 学習速度 | 推論速度 (FPS) |
| --- | --- | --- |
| **SparseDrive-B (ベース版)** | **4.8倍** 高速 | **4.1倍** 高速 |
| **SparseDrive-S (軽量版)** | **7.2倍** 高速 | **5.0倍** 高速 |

---

## 要点：SparseDriveが示したこと

この実験結果から、SparseDriveは**「高精度・高効率・高安全」**という、自動運転システムが求める3要素を同時に高次元で実現したと言えます。特に、計算資源を大幅に節約（4090 GPUで動作可能）しながら、安全性をこれまでの数倍に高めた点は実用化に向けた大きな一歩です。


ご提示いただいた「4.2 アブレーション学習（要素別評価）」のセクションを日本語で要約します。このセクションでは、SparseDriveのデザイン選択がなぜ有効なのかを、各機能をあえて外した比較実験によって証明しています。

---

## 4.2 アブレーション学習（要素別評価）

SparseDriveの各設計要素が、最終的なパフォーマンス（特に安全性）にどう寄与しているかを検証しています。

### 1. モーションプランナーの設計効果

以下の機能を無効化または変更した場合、性能が低下することが確認されました（表4参照）。

* **並列設計の重要性:** 予測と計画を「並列」から「順次（他車予測の後に自車計画）」に変えると、他車の予測精度が悪化し、衝突率が上昇しました。
* **自車情報の初期化:** 自車インスタンスにセマンティック（意味的）・幾何学的情報を与えない場合、走行誤差（L2）と衝突率の両方が悪化しました。
* **マルチモーダル性の欠如:** 走行計画を「決定論的（1つの軌道のみ）」として扱うと、**衝突率が最も高く**なりました。
* **時系列相互作用:** インスタンスレベルの過去情報の参照を外すと、走行誤差（L2）が 0.58m から 0.77m へと大幅に悪化しました。

### 2. 衝突リスクを考慮した再スコアリング (Collision-Aware Rescore)

従来の「後処理」による安全性向上策と、SparseDriveの手法を比較しています（表5参照）。

* **従来の後処理:** 認識結果に基づき無理やり経路を修正する手法。これはエンドツーエンドの学習フローを壊すため、走行誤差（L2）を深刻に悪化させるだけでなく、結果として衝突率を逆に高めてしまう（より危険になる）ことが判明しました。
* **提案手法:** 計画候補のスコアを衝突リスクに基づき調整する手法。これにより、走行誤差への影響を最小限に抑えつつ、衝突率を **0.12% から 0.08%** へと効果的に低減させました。

### 3. プランニングのモード数（候補数）

自車の走行計画としていくつの選択肢（モード）を持つべきかを検証しました（表6参照）。

* モード数を増やすほど性能は向上し、**6モード**で飽和（最適化）することが分かりました。これは、複雑なシーンにおいて自車が複数の回避策を検討できる「マルチモーダルな計画」の重要性を裏付けています。

---

### 要点：なぜSparseDriveは安全なのか

アブレーション学習の結果から、SparseDriveの安全性は**「自車を周囲の一部として捉える並列処理」**、**「常に複数の逃げ道を考えるマルチモーダル性」**、そして**「学習結果を壊さずに安全性を高めるスコアリング」**の3点によって支えられていることが明確になりました。


# Conclusion and Future Work



## 結論

本研究では、エンドツーエンドの自動運転における**「スパース（疎）なシーン表現」**の探索と、各タスク設計の再検討を行いました。その成果である新パラダイム **SparseDrive** は、圧倒的なパフォーマンスと高い計算効率を同時に実現しました。
著者らは、SparseDriveが示す優れた性能が、今後のエンドツーエンド自動運転におけるタスク設計のあり方を再考するきっかけとなり、この分野の技術進歩を促進することを期待しています。

## 今後の課題（限界事項）

現時点では以下の制限があり、今後の研究課題として挙げられています。

1. **単一タスク専門モデルとの差:** エンドツーエンドモデルとしての性能は非常に高いものの、オンラインマッピングなどの特定のタスク単体で見ると、そのタスク専用に特化した手法の性能にはまだ及びません。
2. **データセットの規模:** nuScenesデータセットの規模は、エンドツーエンド自動運転の真の可能性を最大限に引き出すにはまだ十分ではありません。
3. **評価手法:** 現在の「オープンループ評価（録画データに対する評価）」だけでは、実際の走行におけるモデルの性能を完全かつ包括的に表現することは困難です（※クローズドループ評価への期待）。

---

## 全体のまとめ：SparseDriveが自動運転にもたらす価値

この論文を通じて、SparseDriveは**「BEV（俯瞰図）を生成しなければならない」という従来の固定観念を打破**しました。

* **効率:** 疎なデータのみを扱うことで、劇的な高速化を実現。
* **安全:** 自車と他車を並列に扱い、複数の進路候補から衝突リスクを評価して選ぶ「人間らしい」判断ロジックを導入。
* **統合:** 検知・追跡・地図作成を一つの対称的な構造でまとめ上げ、システムをシンプルに構築。





## SparseDriveの推論プロセス

SparseDriveの最大の特徴は、重いBEV（鳥瞰図）画像を作らず、**「インスタンス（物体や地図要素）」を「疎（Sparse）な点」として直接扱う**点にあります。

### 1. 画像の特徴抽出 (Feature Extraction)

まず、車載された複数のカメラ（nuScenesでは6台）からの画像が入力されます。

* **バックボーン:** ResNetなどのネットワークを用いて、各画像の視覚的特徴を抽出します。
* **マルチスケール特徴量:** 遠くの小さい物体から近くの大きい物体まで対応できるよう、異なる解像度の特徴マップを生成します。

### 2. 対称型スパース認識 (Symmetric Sparse Perception)

ここがSparseDriveの心臓部です。「動く物体」と「動かない地図」を、全く同じ構造のネットワークで同時に認識します。

* **インスタンスの定義:** * **他車エージェント:** 位置・サイズ・速度などを持つ「アンカーボックス」として表現。
* **地図要素:** 車線や境界線などを「アンカーポリライン（点の集合）」として表現。


* **特徴のサンプリング:** 3D空間上のアンカーを画像平面に投影し、その場所の画像特徴だけをピンポイントで取得します（BEV全体を作らないため、ここで計算コストが大幅に削減されます）。
* **反復更新:** 複数回のデコーダ処理を経て、物体の位置や種類をより正確に洗練（Refine）させていきます。

### 3. 自車インスタンスの初期化 (Ego Initialization)

自車（Ego）も他車と同じ「一つのインスタンス」として扱いますが、自車はカメラに映らないため工夫が必要です。

* **フロントカメラの活用:** 正面の画像特徴から、現在の走行環境のコンテキスト（意味情報）を抽出して自車の特徴量とします。
* **速度の予測:** 過去のフレームから現在の自車の速度や加速度を予測し、アンカー情報として保持します。

### 4. 並列モーションプランナー (Parallel Motion Planning)

自車と他車の情報を統合し、将来の動きを決定します。

* **空間・時間的相互作用:** Self-Attention（自車・他車間の譲り合いなどの関係性学習）や、Cross-Attention（地図情報に基づいた進路の制約）を行い、全エージェントの相互影響を計算します。
* **並列出力:** * **他車の予測:** 各他車が将来どこへ動くか（マルチモーダルな軌道）を予測。
* **自車の計画:** 「右折・左折・直進」といったコマンドに基づき、複数の走行候補（軌道プロポーザル）を同時に生成します。



### 5. 階層的な計画選択 (Planning Selection)

最後に、大量の候補の中から「最も安全で合理的な1本」を選び出します。

* **衝突検知（Collision-Aware Rescore）:** ステップ4で予測した「他車の将来位置」と「自車の走行候補」を重ね合わせ、衝突する可能性がある候補のスコアを0にします。
* **最終出力:** 指示されたコマンドに適合し、かつ最も安全スコアが高い軌道を選択。これが車両の制御部へと送られます。

---

### まとめ：SparseDriveの効率性の秘密

従来のモデルが「周辺環境をすべて絵（BEV）として描き出してから考える」のに対し、SparseDriveは**「注目すべき対象（インスタンス）だけを点の集合として追跡し、並列に判断する」**という流れになっています。これが、UniADなどの従来手法より5倍以上速く、かつ安全である理由です。




# SparseDriveの主要な出力

推論の最終的な出力は、一言で言えば**「自車が今後数秒間にわたって進むべき具体的な経路（座標のリスト）」**です。

## 1. 走行軌道 (Ego Trajectory)

これが最も重要な出力です。自車が今後  秒間にわたって通るべき地点が、時系列の座標データとして出力されます。

* **データ形式:**  個の  座標のセット。
* 例：現在を  としたとき、0.5秒後は 、1.0秒後は  という形式です。


* **制御への利用:** 車両の制御ユニット（CANバス等）はこの座標リストを受け取り、ハンドルを切る角度（ステアリング）とアクセル・ブレーキ（加減速）を計算して、実際に車を動かします。

## 2. 周囲エージェントの予測軌道 (Multimodal Predictions)

自車の経路だけでなく、「周りの車や歩行者がどう動くか」という予測結果も同時に出力されます。

* **内容:** 認識した各他車（インスタンス）について、複数の将来予測ルートとその確率が出力されます。
* **役割:** SparseDriveの内部では、この他車の予測軌道と自車の計画を照らし合わせることで、**「あそこを走っている車が急ブレーキをかけそうだから、自車はこのルートを通るのをやめよう」**といった衝突回避の判断を行っています。

## 3. 現在の自車のステータス (Ego Status)

入力された画像から、現在の自車の状態を改めて推定した値も出力されます。

* **出力項目:** 現在の速度（Velocity）、加速度（Acceleration）、角速度（Angular Velocity）、ステアリング角（Steering Angle）。
* **役割:** 車両自身のセンサー値（車速パルス等）との整合性を確認したり、次フレームの推論の初期値として利用されます。

---

# 推論から実走行までのデータの流れ

車載カメラから画像が入ってから、車が動くまでのデータの流れを可視化すると以下のようになります。

1. **入力:** 6枚の画像（周囲360度）
2. **内部処理（SparseDrive）:** * 他車を点と箱で捉える（Detection/Tracking）
* 車線を線で捉える（Mapping）
* 自車と他車の未来の動きをシミュレートする（Prediction & Planning）


3. **出力:** **最適な1本の走行軌道（座標群）**
4. **実行:** 車両制御アルゴリズム（PID制御やMPC等）が軌道を追従するようにタイヤやエンジンを動かす。

## 補足：出力の安全性

SparseDriveは単に「一番速い道」を出すのではなく、内部で生成した複数の候補（マルチモーダルな計画）の中から、**他車との衝突リスクが最も低く、かつナビからの指令（左折せよ、など）に沿ったもの**を選び抜いて出力しているのが強みです。

